#include <glib.h>
#include <gmime/gmime.h>

#define QUEUE_DIR "@SPMFILTER_QUEUE_DIR@"
#define LIB_DIR "@LIBDIR@"

#define EMAIL_EXTRACT "(?:.*<)?([^>]*)(?:>)?"

typedef struct {
	gboolean debug;
	char *config_file;
	char *engine;
	char *spool_dir;
	gchar **modules;
	int module_fail;
	
} SETTINGS;

typedef struct {
	char *from;
	GSList *rcpt;
	char *message_file;
	char *auth_user;
	char *auth_pass;
	char *nexthop;
} MESSAGE;

typedef struct {
	/* hello we received */
	char *helo;
	
	/* recipients */
	GSList *rcpt;
	
	/* sender */
	char *from;
	
	/* size of message body */
	size_t msgbodysize;
	
	/* this is our spooling file */
	char *queue_file;
	
	/* xfoward */
	char *xforward_addr;

	/* hash table for headers */
	GHashTable *header_checks;
	
	char *nexthop;
	int nexthop_fail_code;
	char *nexthop_fail_msg;
	
	/* hash table for runtime data */
	GHashTable *runtime_data;
} MAILCONN;

typedef struct {
	const char *name;
	const char *value;
} HEADER;


typedef struct {
	SETTINGS *settings;
	MAILCONN *mconn;
	gchar *line;
	GMimeMessage *message;
} HL;

char* get_substring(const char *pattern, const char *line, int pos);
void header_check(gpointer k, gpointer v, gpointer user_data);
int smtp_devlier(SETTINGS *settings, MESSAGE *msg_data);
